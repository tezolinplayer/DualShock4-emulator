name: Build Windows

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.0.5

    # 1. Cria os Headers (.h) manualmente
    - name: Create ViGEm Headers
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path Source\ViGEm
        
        $commonContent = @"
        #pragma once
        #include <windows.h>
        typedef struct _DS4_TOUCH { BYTE bPacketCounter; BYTE bIsUpTrackingNum1; BYTE bTouchData1[3]; BYTE bIsUpTrackingNum2; BYTE bTouchData2[3]; } DS4_TOUCH, *PDS4_TOUCH;
        typedef struct _DS4_REPORT_EX { BYTE bThumbLX; BYTE bThumbLY; BYTE bThumbRX; BYTE bThumbRY; USHORT wButtons; BYTE bSpecial; BYTE bTriggerL; BYTE bTriggerR; USHORT wTimestamp; BYTE bBatteryLvl; SHORT wGyroX, wGyroY, wGyroZ; SHORT wAccelX, wAccelY, wAccelZ; BYTE _reserved1[5]; BYTE bTouchPacketsN; DS4_TOUCH sCurrentTouch; DS4_TOUCH sPreviousTouch[2]; } DS4_REPORT_EX, *PDS4_REPORT_EX;
        #define DS4_REPORT_INIT_EX(pReport) { memset((pReport), 0, sizeof(DS4_REPORT_EX)); }
        #define DS4_BUTTON_THUMB_RIGHT (1 << 15)
        #define DS4_BUTTON_THUMB_LEFT (1 << 14)
        #define DS4_BUTTON_OPTIONS (1 << 13)
        #define DS4_BUTTON_SHARE (1 << 12)
        #define DS4_BUTTON_TRIGGER_RIGHT (1 << 11)
        #define DS4_BUTTON_TRIGGER_LEFT (1 << 10)
        #define DS4_BUTTON_SHOULDER_RIGHT (1 << 9)
        #define DS4_BUTTON_SHOULDER_LEFT (1 << 8)
        #define DS4_BUTTON_TRIANGLE (1 << 7)
        #define DS4_BUTTON_CIRCLE (1 << 6)
        #define DS4_BUTTON_CROSS (1 << 5)
        #define DS4_BUTTON_SQUARE (1 << 4)
        #define DS4_SPECIAL_BUTTON_PS (1 << 0)
        #define DS4_SPECIAL_BUTTON_TOUCHPAD (1 << 1)
        #define DS4_BUTTON_DPAD_NONE 0x8
        #define DS4_BUTTON_DPAD_NORTH 0x0
        #define DS4_BUTTON_DPAD_NORTHEAST 0x1
        #define DS4_BUTTON_DPAD_EAST 0x2
        #define DS4_BUTTON_DPAD_SOUTHEAST 0x3
        #define DS4_BUTTON_DPAD_SOUTH 0x4
        #define DS4_BUTTON_DPAD_SOUTHWEST 0x5
        #define DS4_BUTTON_DPAD_WEST 0x6
        #define DS4_BUTTON_DPAD_NORTHWEST 0x7
        #define DS4_SET_DPAD_EX(pReport, dpad) { (pReport)->wButtons &= ~0xF; (pReport)->wButtons |= (dpad); }
        typedef void* PVIGEM_CLIENT; typedef void* PVIGEM_TARGET; typedef enum _DS4_LIGHTBAR_COLOR { DS4_LIGHTBAR_COLOR_OFF } DS4_LIGHTBAR_COLOR; typedef void (*PVIGEM_DS4_NOTIFICATION)(PVIGEM_CLIENT, PVIGEM_TARGET, UCHAR, UCHAR, DS4_LIGHTBAR_COLOR, LPVOID);
        "@
        Set-Content -Path "Source\ViGEm\Common.h" -Value $commonContent

        $clientContent = @"
        #pragma once
        #include "Common.h"
        #ifdef __cplusplus
        extern "C" {
        #endif
            __declspec(dllimport) PVIGEM_CLIENT vigem_alloc(void);
            __declspec(dllimport) void vigem_free(PVIGEM_CLIENT client);
            __declspec(dllimport) int vigem_connect(PVIGEM_CLIENT client);
            __declspec(dllimport) void vigem_disconnect(PVIGEM_CLIENT client);
            __declspec(dllimport) PVIGEM_TARGET vigem_target_ds4_alloc(void);
            __declspec(dllimport) void vigem_target_free(PVIGEM_TARGET target);
            __declspec(dllimport) int vigem_target_add(PVIGEM_CLIENT client, PVIGEM_TARGET target);
            __declspec(dllimport) int vigem_target_remove(PVIGEM_CLIENT client, PVIGEM_TARGET target);
            __declspec(dllimport) int vigem_target_ds4_register_notification(PVIGEM_CLIENT client, PVIGEM_TARGET target, PVIGEM_DS4_NOTIFICATION notification, LPVOID userData);
            __declspec(dllimport) void vigem_target_ds4_unregister_notification(PVIGEM_TARGET target);
            __declspec(dllimport) int vigem_target_ds4_update_ex(PVIGEM_CLIENT client, PVIGEM_TARGET target, DS4_REPORT_EX report);
        #ifdef __cplusplus
        }
        #endif
        "@
        Set-Content -Path "Source\ViGEm\Client.h" -Value $clientContent
        Set-Content -Path "Source\ViGEm\Util.h" -Value "#pragma once"

    # 2. Compila a LIB do ViGEm e salva na pasta "Libs"
    - name: Build ViGEmClient Lib
      shell: powershell
      run: |
        git clone https://github.com/nefarius/ViGEmClient.git vigem_src
        nuget restore vigem_src/ViGEmClient.sln
        
        # Cria pasta "Libs" na raiz
        $libsDir = "${{ github.workspace }}\Libs"
        New-Item -ItemType Directory -Force -Path $libsDir
        
        # Compila com saída direcionada
        msbuild vigem_src/src/ViGEmClient.vcxproj /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:OutDir="$libsDir\"
        
        # Verifica se criou
        if (Test-Path "$libsDir\ViGEmClient.lib") {
            Write-Host "SUCESSO: Lib gerada em $libsDir\ViGEmClient.lib"
        } else {
            Write-Error "FALHA CRÍTICA: ViGEmClient.lib não encontrada."
            exit 1
        }

    # 3. TRUQUE FINAL: Cria o arquivo de configuração global para forçar o Linker a ver a pasta Libs
    - name: Create Global Build Props
      shell: powershell
      run: |
        $propsContent = @"
        <Project>
          <PropertyGroup>
            <LibraryPath>`$(MSBuildThisFileDirectory)Libs;`$(LibraryPath)</LibraryPath>
          </PropertyGroup>
        </Project>
        "@
        Set-Content -Path "Directory.Build.props" -Value $propsContent
        Write-Host "Arquivo Directory.Build.props criado com sucesso."

    # 4. Compila o Emulador (O MSBuild vai ler o arquivo acima automaticamente)
    - name: Build Solution
      run: msbuild Source/DS4Emulator.vcxproj /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:WindowsTargetPlatformVersion=10.0

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DS4Emulator-XIM
        path: Source/x64/Release/*.exe

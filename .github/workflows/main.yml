name: Build Windows

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 1. Cria os Headers (.h) manualmente (Isso garante que o código compile sem erro de types)
    - name: Create ViGEm Headers
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path Source\ViGEm
        
        # --- Common.h ---
        $commonContent = @"
        #pragma once
        #include <windows.h>
        typedef struct _DS4_TOUCH { BYTE bPacketCounter; BYTE bIsUpTrackingNum1; BYTE bTouchData1[3]; BYTE bIsUpTrackingNum2; BYTE bTouchData2[3]; } DS4_TOUCH, *PDS4_TOUCH;
        typedef struct _DS4_REPORT_EX { BYTE bThumbLX; BYTE bThumbLY; BYTE bThumbRX; BYTE bThumbRY; USHORT wButtons; BYTE bSpecial; BYTE bTriggerL; BYTE bTriggerR; USHORT wTimestamp; BYTE bBatteryLvl; SHORT wGyroX, wGyroY, wGyroZ; SHORT wAccelX, wAccelY, wAccelZ; BYTE _reserved1[5]; BYTE bTouchPacketsN; DS4_TOUCH sCurrentTouch; DS4_TOUCH sPreviousTouch[2]; } DS4_REPORT_EX, *PDS4_REPORT_EX;
        #define DS4_REPORT_INIT_EX(pReport) { memset((pReport), 0, sizeof(DS4_REPORT_EX)); }
        #define DS4_BUTTON_THUMB_RIGHT (1 << 15)
        #define DS4_BUTTON_THUMB_LEFT (1 << 14)
        #define DS4_BUTTON_OPTIONS (1 << 13)
        #define DS4_BUTTON_SHARE (1 << 12)
        #define DS4_BUTTON_TRIGGER_RIGHT (1 << 11)
        #define DS4_BUTTON_TRIGGER_LEFT (1 << 10)
        #define DS4_BUTTON_SHOULDER_RIGHT (1 << 9)
        #define DS4_BUTTON_SHOULDER_LEFT (1 << 8)
        #define DS4_BUTTON_TRIANGLE (1 << 7)
        #define DS4_BUTTON_CIRCLE (1 << 6)
        #define DS4_BUTTON_CROSS (1 << 5)
        #define DS4_BUTTON_SQUARE (1 << 4)
        #define DS4_SPECIAL_BUTTON_PS (1 << 0)
        #define DS4_SPECIAL_BUTTON_TOUCHPAD (1 << 1)
        #define DS4_BUTTON_DPAD_NONE 0x8
        #define DS4_BUTTON_DPAD_NORTH 0x0
        #define DS4_BUTTON_DPAD_NORTHEAST 0x1
        #define DS4_BUTTON_DPAD_EAST 0x2
        #define DS4_BUTTON_DPAD_SOUTHEAST 0x3
        #define DS4_BUTTON_DPAD_SOUTH 0x4
        #define DS4_BUTTON_DPAD_SOUTHWEST 0x5
        #define DS4_BUTTON_DPAD_WEST 0x6
        #define DS4_BUTTON_DPAD_NORTHWEST 0x7
        #define DS4_SET_DPAD_EX(pReport, dpad) { (pReport)->wButtons &= ~0xF; (pReport)->wButtons |= (dpad); }
        typedef void* PVIGEM_CLIENT; typedef void* PVIGEM_TARGET; typedef enum _DS4_LIGHTBAR_COLOR { DS4_LIGHTBAR_COLOR_OFF } DS4_LIGHTBAR_COLOR; typedef void (*PVIGEM_DS4_NOTIFICATION)(PVIGEM_CLIENT, PVIGEM_TARGET, UCHAR, UCHAR, DS4_LIGHTBAR_COLOR, LPVOID);
        "@
        Set-Content -Path "Source\ViGEm\Common.h" -Value $commonContent

        # --- Client.h ---
        $clientContent = @"
        #pragma once
        #include "Common.h"
        #ifdef __cplusplus
        extern "C" {
        #endif
            __declspec(dllimport) PVIGEM_CLIENT vigem_alloc(void);
            __declspec(dllimport) void vigem_free(PVIGEM_CLIENT client);
            __declspec(dllimport) int vigem_connect(PVIGEM_CLIENT client);
            __declspec(dllimport) void vigem_disconnect(PVIGEM_CLIENT client);
            __declspec(dllimport) PVIGEM_TARGET vigem_target_ds4_alloc(void);
            __declspec(dllimport) void vigem_target_free(PVIGEM_TARGET target);
            __declspec(dllimport) int vigem_target_add(PVIGEM_CLIENT client, PVIGEM_TARGET target);
            __declspec(dllimport) int vigem_target_remove(PVIGEM_CLIENT client, PVIGEM_TARGET target);
            __declspec(dllimport) int vigem_target_ds4_register_notification(PVIGEM_CLIENT client, PVIGEM_TARGET target, PVIGEM_DS4_NOTIFICATION notification, LPVOID userData);
            __declspec(dllimport) void vigem_target_ds4_unregister_notification(PVIGEM_TARGET target);
            __declspec(dllimport) int vigem_target_ds4_update_ex(PVIGEM_CLIENT client, PVIGEM_TARGET target, DS4_REPORT_EX report);
        #ifdef __cplusplus
        }
        #endif
        "@
        Set-Content -Path "Source\ViGEm\Client.h" -Value $clientContent
        Set-Content -Path "Source\ViGEm\Util.h" -Value "#pragma once"

    # 2. Baixa a LIB procurando em MÚLTIPLAS versões (Loop Inteligente)
    - name: Download ViGEm Lib (Smart Loop)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: powershell
      run: |
        $destDir = "Source\ViGEm\lib\x64"
        New-Item -ItemType Directory -Force -Path $destDir
        
        $apiUrl = "https://api.github.com/repos/nefarius/ViGEmClient/releases"
        $headers = @{ Authorization = "token $env:GITHUB_TOKEN" }
        
        Write-Host "Buscando lista de releases..."
        try {
            $releases = Invoke-RestMethod -Uri $apiUrl -Headers $headers
            
            $found = $false
            
            # Loop pelas primeiras 15 releases
            foreach ($rel in $releases | Select-Object -First 15) {
                Write-Host "Verificando versão: $($rel.tag_name)"
                
                # Procura um asset ZIP que contenha 'x64' e 'VS2019'
                $asset = $rel.assets | Where-Object { $_.name -like "*x64*VS2019*.zip" } | Select-Object -First 1
                
                if ($asset) {
                    Write-Host ">>> Asset ENCONTRADO: $($asset.name)"
                    Write-Host "Baixando de: $($asset.browser_download_url)"
                    
                    Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "vigem_sdk.zip"
                    
                    # Tenta extrair
                    if (Test-Path "vigem_temp") { Remove-Item "vigem_temp" -Recurse -Force }
                    Expand-Archive -Path "vigem_sdk.zip" -DestinationPath "vigem_temp" -Force
                    
                    # Procura o arquivo .lib
                    $libFile = Get-ChildItem -Path "vigem_temp" -Recurse -Filter "ViGEmClient.lib" | Select-Object -First 1
                    
                    if ($libFile) {
                        Copy-Item -Path $libFile.FullName -Destination "$destDir\ViGEmClient.lib"
                        Write-Host "SUCESSO: Lib instalada em $destDir\ViGEmClient.lib"
                        $found = $true
                        break # Sai do loop
                    } else {
                        Write-Warning "ZIP baixado não continha o arquivo .lib. Tentando próxima versão..."
                    }
                }
            }
            
            if (-not $found) {
                throw "Nenhuma release válida com ViGEmClient.lib foi encontrada após verificar 15 versões."
            }
            
        } catch {
            Write-Error "Erro fatal no processo de download: $_"
            exit 1
        }

    - name: Build Solution
      run: msbuild Source/DS4Emulator.vcxproj /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:WindowsTargetPlatformVersion=10.0

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DS4Emulator-XIM
        path: Source/x64/Release/*.exe
